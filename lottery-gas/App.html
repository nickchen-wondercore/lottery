<script>
/**
 * App.html ‚Äî ÊáâÁî®Á®ãÂºèÊéßÂà∂Âô®ÔºàMaster / Viewer ÈõôÊ®°ÂºèÔºâ
 * Master: ÂÆåÊï¥Êìç‰Ωú + Êé®ÈÄÅÂêåÊ≠•Êåá‰ª§ + ÂõûÂØ´ Sheets
 * Viewer: Êé•Êî∂Êåá‰ª§ + Âü∑Ë°åÂ∞çÊáâÂãï‰ΩúÔºàÁÑ°ÊåâÈàïÊìç‰ΩúÔºâ
 */
const App = (() => {
  const MAX_FRAME_DELTA = 32;
  const FIRST_EJECT_DELAY = 3000;
  const SETTLE_DELAY = 2000;
  const DEFAULT_BALL_RADIUS = 24;

  // Áî± Index.html ÁöÑ data-mode Â±¨ÊÄßÊ≥®ÂÖ•
  const MODE = document.body.dataset.mode || 'master';
  const IS_MASTER = MODE === 'master';
  const IS_VIEWER = MODE === 'viewer';

  let state = 'IDLE';
  let names = [];
  let allNamesWithStatus = [];
  let winners = [];
  let animFrameId = null;
  let lastTime = 0;
  let ballRadius = DEFAULT_BALL_RADIUS;
  let currentRound = 1;
  let settings = {};

  // Firebase ÈÅôÊéßÂô®Áî®
  let lastFirebaseTimestamp = 0;

  // ‚îÄ‚îÄ DOM ÂÖÉÁ¥†ÂèÉËÄÉ ‚îÄ‚îÄ
  const btnLoad = document.getElementById('btn-load');
  const btnSpin = document.getElementById('btn-spin');
  const btnDraw = document.getElementById('btn-draw');
  const btnReset = document.getElementById('btn-reset');
  const inputCount = document.getElementById('input-count');
  const inputInterval = document.getElementById('input-interval');
  const inputSwirl = document.getElementById('input-swirl');
  const namesList = document.getElementById('names-list');
  const winnerList = document.getElementById('winner-list');
  const canvasEl = document.getElementById('canvas');
  const inputBallSize = document.getElementById('input-ball-size');
  const inputFontSize = document.getElementById('input-font-size');
  const viewerStatus = document.getElementById('viewer-status');
  const viewerStatusText = document.getElementById('viewer-status-text');
  const selectSheet = document.getElementById('select-sheet');

  // ‚îÄ‚îÄ Viewer Âá∫ÁêÉÈöäÂàó ‚îÄ‚îÄ
  let ejectQueue = [];
  let isProcessingEject = false;

  /** ÂèñÂæóÁõÆÂâçÈÅ∏ÂèñÁöÑÂ∑•‰ΩúË°®ÂêçÁ®± */
  function getSelectedSheet() {
    return selectSheet ? selectSheet.value : '';
  }

  /** Âà∑Êñ∞ÂêçÂñÆÈ°ØÁ§∫ÔºàÂ∑¶ÂÅ¥Èù¢Êùø + Âè≥ÂÅ¥‰∏≠ÁçéÈù¢Êùø + Êï∏Èáè‰∏äÈôêÔºâ */
  function refreshNameDisplay() {
    populateNamesList();
    inputCount.max = names.length;
    inputCount.value = Math.min(parseInt(inputCount.value, 10) || 1, names.length);
    winnerList.innerHTML = '';
    if (winners.length > 0) {
      winners.forEach(name => {
        winnerList.appendChild(createWinnerLi(name));
      });
    }
  }

  // ===== ÂÖ±Áî®ÂáΩÂºè =====

  /** Âæû Google Sheets ËºâÂÖ•ÂèØÁî®ÁöÑÂ∑•‰ΩúË°®ÂêçÁ®± */
  function loadSheetNames() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(sheetNames => {
          selectSheet.innerHTML = '';
          sheetNames.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            selectSheet.appendChild(opt);
          });
          resolve(sheetNames);
        })
        .withFailureHandler(reject)
        .api_getListSheetNames();
    });
  }

  /** Âæû Google Sheets ËºâÂÖ•ÂêçÂñÆ */
  function loadNamesFromSheets() {
    const sheetName = getSelectedSheet();
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(result => {
          allNamesWithStatus = result;
          names = result.filter(r => !r.won).map(r => r.name);
          winners = result.filter(r => r.won).map(r => r.name);
          resolve();
        })
        .withFailureHandler(reject)
        .api_getAllNamesWithStatus(sheetName);
    });
  }

  /** Âæû Google Sheets ËºâÂÖ•Ë®≠ÂÆö */
  function loadSettings() {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(result => {
          settings = result;
          applySettings(result);
          resolve();
        })
        .withFailureHandler(reject)
        .api_getSettings();
    });
  }

  /** Â•óÁî®Ë®≠ÂÆöÂà∞ UI ÊéßÂà∂È†Ö */
  function applySettings(s) {
    if (s.ballSize) inputBallSize.value = s.ballSize;
    if (s.fontSize !== undefined) inputFontSize.value = s.fontSize;
    if (s.swirl) inputSwirl.value = s.swirl;
    if (s.interval) inputInterval.value = s.interval;
    if (s.count) inputCount.value = s.count;
  }

  function populateNamesList() {
    namesList.innerHTML = '';
    allNamesWithStatus.forEach(item => {
      const li = document.createElement('li');
      li.dataset.name = item.name;
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = 'üéØ';
      li.appendChild(badge);
      li.appendChild(document.createTextNode(item.name));
      if (item.won) li.classList.add('won');
      namesList.appendChild(li);
    });
  }

  /** Ë®àÁÆó‰∏≠ÁçéÁêÉÈ´îÂÖßÊñáÂ≠óÁöÑËá™ÈÅ©ÊáâÂ§ßÂ∞èÔºà‰ªø renderer ÁöÑ Canvas ÁêÉÈ´îÊñáÂ≠óÁ∏ÆÊîæÈÇèËºØÔºâ */
  function calcBallFontSize(name, ballDiameter) {
    const usableWidth = ballDiameter * 0.78;
    let totalWeight = 0;
    for (const ch of name) {
      totalWeight += ch.charCodeAt(0) > 0x7F ? 1 : 0.6;
    }
    if (totalWeight === 0) return 14;
    const size = usableWidth / totalWeight;
    return Math.max(6, Math.min(14, size));
  }

  /** Âª∫Á´ã‰∏≠ÁçéËÄÖ <li> ÂÖÉÁ¥†ÔºàÁ±§ÁêÉ + ÂêçÂ≠óÔºâ */
  function createWinnerLi(name) {
    const li = document.createElement('li');
    const ball = document.createElement('span');
    ball.className = 'winner-ball';
    ball.textContent = name;
    ball.style.fontSize = calcBallFontSize(name, 38) + 'px';
    const nameSpan = document.createElement('span');
    nameSpan.className = 'winner-name';
    nameSpan.textContent = name;
    li.appendChild(ball);
    li.appendChild(nameSpan);
    return li;
  }

  function markWinner(name) {
    const items = namesList.querySelectorAll('li');
    for (const li of items) {
      if (li.dataset.name === name && !li.classList.contains('won')) {
        li.classList.add('won');
        li.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        break;
      }
    }
  }

  function addToWinnerList(name) {
    winners.push(name);
    markWinner(name);
    winnerList.appendChild(createWinnerLi(name));
    winnerList.scrollTop = winnerList.scrollHeight;
  }

  function setState(newState) {
    state = newState;
    Sync.setState(newState);
    updateUI();
    if (IS_MASTER) writeFirebaseStatus();
  }

  /** Master: ÂØ´ÂÖ• Firebase status ‰æõ Controller ËÆÄÂèñ */
  function writeFirebaseStatus() {
    if (typeof FirebaseDB === 'undefined') return;
    FirebaseDB.statusRef.set({ state: state });
  }

  function updateUI() {
    if (IS_VIEWER) {
      // Viewer Ê®°ÂºèÔºöÊâÄÊúâÊåâÈàïÊ∞∏ÈÅ†Èö±ËóèÔºàÁî± CSS ËôïÁêÜÔºâ
      if (viewerStatusText) {
        const labels = {
          IDLE: 'Á≠âÂæÖ‰∏ªÊéßÁ´ØÈñãÂßã...',
          LOADING: 'Ê≠£Âú®ËºâÂÖ•ÁêÉÈ´î...',
          READY: 'Â∞±Á∑í',
          SPINNING: 'ËΩâÂãï‰∏≠...',
          DRAWING: 'ÊäΩÁ±§‰∏≠...',
          COMPLETE: 'ÊäΩÁçéÂÆåÊàêÔºÅ'
        };
        viewerStatusText.textContent = labels[state] || state;
      }
      return;
    }

    // Master Ê®°ÂºèÔºöÊ≠£Â∏∏ÊåâÈàïÈÇèËºØ
    btnLoad.disabled = state !== 'IDLE';
    btnSpin.disabled = (state !== 'READY' && state !== 'SPINNING');
    btnSpin.textContent = state === 'SPINNING' ? 'ÂÅúÊ≠¢' : 'ËΩâÂãï';
    btnSpin.classList.toggle('spinning', state === 'SPINNING');
    btnDraw.disabled = state !== 'SPINNING';
    btnReset.disabled = (state === 'IDLE' || state === 'LOADING' || state === 'DRAWING');
    inputCount.disabled = (state !== 'READY' && state !== 'IDLE' && state !== 'SPINNING');
    inputBallSize.disabled = state !== 'IDLE';
    selectSheet.disabled = state !== 'IDLE';
  }

  let physicsInited = false;

  function applyUserSettings() {
    ballRadius = parseInt(inputBallSize.value, 10) || DEFAULT_BALL_RADIUS;
    Physics.setBallRadius(ballRadius);
    Renderer.setFontSize(parseInt(inputFontSize.value, 10) || 0);
    Physics.setSwirlMultiplier((parseInt(inputSwirl.value, 10) || 75) / 10);
  }

  function initPhysicsAndRenderer() {
    if (!physicsInited) {
      Physics.init();
      physicsInited = true;
    }
    Renderer.init(canvasEl);
    applyUserSettings();
    const { width, height } = Renderer.getSize();
    Physics.layout(width, height);
  }

  function drawPreview() {
    initPhysicsAndRenderer();
    Renderer.drawFrame();
  }

  function startLoop() {
    if (animFrameId) return;
    lastTime = performance.now();
    function loop(now) {
      const delta = Math.min(now - lastTime, MAX_FRAME_DELTA);
      lastTime = now;
      Physics.update(delta);
      Renderer.drawFrame();
      animFrameId = requestAnimationFrame(loop);
    }
    animFrameId = requestAnimationFrame(loop);
  }

  function stopLoop() {
    if (animFrameId) {
      cancelAnimationFrame(animFrameId);
      animFrameId = null;
    }
  }

  // ===== Master Â∞àÁî®ÂáΩÂºè =====

  function handleLoad() {
    if (state !== 'IDLE') return;
    setState('LOADING');

    applyUserSettings();
    const { width, height } = Renderer.getSize();
    Physics.layout(width, height);
    startLoop();

    // Êé®ÈÄÅ INIT Êåá‰ª§
    Sync.push({
      action: 'INIT',
      payload: {
        names: names,
        sheetName: getSelectedSheet(),
        settings: {
          ballSize: parseInt(inputBallSize.value, 10),
          fontSize: parseInt(inputFontSize.value, 10),
          swirl: parseInt(inputSwirl.value, 10),
          interval: parseInt(inputInterval.value, 10),
          count: parseInt(inputCount.value, 10)
        }
      }
    });

    Physics.createBalls(names, ballRadius, () => {
      setTimeout(() => {
        Physics.sealContainer();
        Renderer.setLidSealed(true);
        setState('READY');
        Sync.push({ action: 'SEALED', payload: {} });
      }, SETTLE_DELAY);
    });
  }

  function handleSpin() {
    if (state === 'READY') {
      Physics.startTurbulence();
      setState('SPINNING');
      Sync.push({ action: 'START_TURBULENCE', payload: {} });
    } else if (state === 'SPINNING') {
      Physics.stopTurbulence();
      setState('READY');
      Sync.push({ action: 'STOP_TURBULENCE', payload: {} });
    }
  }

  function handleDraw() {
    if (state !== 'SPINNING') return;
    const count = parseInt(inputCount.value, 10);
    if (!count || count < 1) return;

    const remainingBalls = Physics.getBalls().length;
    const actualCount = Math.min(count, remainingBalls);
    if (actualCount === 0) return;

    setState('DRAWING');
    Sync.push({ action: 'DRAW_START', payload: {} });

    const intervalSec = parseInt(inputInterval.value, 10) || 3;
    let drawn = 0;

    function ejectCycle() {
      Physics.openExitGate();
      Physics.ejectOneBall((name) => {
        Physics.closeExitGate();

        if (name === null) {
          finishDrawing();
          return;
        }

        drawn++;
        addToWinnerList(name);

        // ÂõûÂØ´ Sheets + Êé®ÈÄÅ EJECT Êåá‰ª§
        google.script.run.api_recordWinner(name, currentRound, getSelectedSheet());
        Sync.push({ action: 'EJECT', payload: { name: name } });

        if (drawn >= actualCount) {
          finishDrawing();
        } else {
          setTimeout(ejectCycle, intervalSec * 1000);
        }
      });
    }

    function finishDrawing() {
      Physics.closeExitGate();
      const remaining = Physics.getBalls().length;
      const hasRemaining = remaining > 0;

      if (!hasRemaining) {
        Physics.stopTurbulence();
        setState('COMPLETE');
      } else {
        Physics.stopTurbulence();
        setState('READY');
        inputCount.max = remaining;
        if (parseInt(inputCount.value, 10) > remaining) {
          inputCount.value = remaining;
        }
      }

      currentRound++;
      Sync.push({ action: 'BATCH_DONE', payload: { hasRemaining: hasRemaining } });
    }

    setTimeout(ejectCycle, FIRST_EJECT_DELAY);
  }

  function handleReset() {
    if (state === 'IDLE' || state === 'LOADING' || state === 'DRAWING') return;

    if (state === 'SPINNING') {
      Physics.stopTurbulence();
    }

    stopLoop();
    Physics.cleanup();

    Renderer.setEntryOpen(false);
    Renderer.setLidSealed(false);

    // Ê∏ÖÈô§ÂêåÊ≠•ÁãÄÊÖã + Êé®ÈÄÅ RESET
    Sync.push({ action: 'RESET', payload: {} }).then(() => {
      Sync.clearSync();
    });

    // ÈáçÊñ∞Âæû Sheets ËÆÄÂèñÔºà‰øùÁïôÂ∑≤‰∏≠ÁçéÁãÄÊÖãÔºâÔºåÂè™ÈáçÂª∫Áï´Èù¢
    loadNamesFromSheets().then(() => {
      populateNamesList();
      winnerList.innerHTML = '';
      // Âè≥ÂÅ¥Èù¢ÊùøÈáçÊñ∞È°ØÁ§∫ÊâÄÊúâÂ∑≤‰∏≠ÁçéËÄÖÔºàÂê´ÂÖàÂâç + Êú¨Ê¨°Ôºâ
      if (winners.length > 0) {
        winners.forEach(name => {
          winnerList.appendChild(createWinnerLi(name));
        });
      }
      inputCount.max = names.length;
      inputCount.value = Math.min(parseInt(inputCount.value, 10) || 1, names.length);
      drawPreview();
      setState('IDLE');
    });
  }

  function handleSwirlChange() {
    const val = parseInt(inputSwirl.value, 10);
    Physics.setSwirlMultiplier(val / 10);
  }

  function handleFontSizeChange() {
    const val = parseInt(inputFontSize.value, 10) || 0;
    Renderer.setFontSize(val);
  }

  function handleResize() {
    if (state === 'IDLE') {
      drawPreview();
      return;
    }
    Renderer.resize();
  }

  // ===== Viewer Â∞àÁî®ÂáΩÂºè =====

  /**
   * ËôïÁêÜÂæû Master Êî∂Âà∞ÁöÑÂêåÊ≠•Êåá‰ª§
   * @param {Array} commands - Êåá‰ª§Èô£Âàó
   */
  function handleSyncCommands(commands) {
    commands.forEach(cmd => {
      switch (cmd.action) {
        case 'INIT':
          viewerInit(cmd.payload);
          break;
        case 'SEALED':
          viewerSealed();
          break;
        case 'START_TURBULENCE':
          viewerStartTurbulence();
          break;
        case 'STOP_TURBULENCE':
          viewerStopTurbulence();
          break;
        case 'DRAW_START':
          viewerDrawStart();
          break;
        case 'EJECT':
          viewerEject(cmd.payload);
          break;
        case 'BATCH_DONE':
          viewerBatchDone(cmd.payload);
          break;
        case 'RESET':
          viewerReset();
          break;
      }
    });
  }

  function viewerInit(payload) {
    names = payload.names || [];
    const s = payload.settings || {};
    applySettings(s);
    applyUserSettings();

    // ÈáçÂª∫ÂÖ®ÂêçÂñÆÁãÄÊÖã
    allNamesWithStatus = names.map(n => ({ name: n, won: false }));
    populateNamesList();

    setState('LOADING');
    const { width, height } = Renderer.getSize();
    Physics.layout(width, height);
    startLoop();

    Physics.createBalls(names, ballRadius, () => {
      // Viewer ‰∏çÈúÄË¶ÅÁ≠âÊ≤âÊæ±ÔºåSEALED Êåá‰ª§ÊúÉÊéßÂà∂
    });
  }

  function viewerSealed() {
    Physics.sealContainer();
    Renderer.setLidSealed(true);
    setState('READY');
  }

  function viewerStartTurbulence() {
    Physics.startTurbulence();
    setState('SPINNING');
  }

  function viewerStopTurbulence() {
    Physics.stopTurbulence();
    setState('READY');
  }

  function viewerDrawStart() {
    setState('DRAWING');
  }

  function viewerEject(payload) {
    if (!payload || !payload.name) return;
    ejectQueue.push(payload.name);
    processEjectQueue();
  }

  /** ÈÄê‰∏ÄËôïÁêÜÂá∫ÁêÉÈöäÂàóÔºàÁ≠â‰∏ä‰∏ÄÈ°ÜÂÆåÊàêÊâçËôïÁêÜ‰∏ã‰∏ÄÈ°ÜÔºâ */
  function processEjectQueue() {
    if (isProcessingEject || ejectQueue.length === 0) return;
    isProcessingEject = true;

    const name = ejectQueue.shift();
    Physics.openExitGate();
    Physics.ejectSpecificBall(name, (ejectedName) => {
      Physics.closeExitGate();
      if (ejectedName) {
        addToWinnerList(ejectedName);
      }
      isProcessingEject = false;
      processEjectQueue();
    });
  }

  function viewerBatchDone(payload) {
    if (payload && payload.hasRemaining) {
      Physics.stopTurbulence();
      setState('READY');
    } else {
      Physics.stopTurbulence();
      setState('COMPLETE');
    }
  }

  function viewerReset() {
    if (state === 'SPINNING') {
      Physics.stopTurbulence();
    }

    stopLoop();
    Physics.cleanup();

    winners = [];
    ejectQueue = [];
    isProcessingEject = false;
    winnerList.innerHTML = '';
    namesList.querySelectorAll('li.won').forEach(li => li.classList.remove('won'));

    Renderer.setEntryOpen(false);
    Renderer.setLidSealed(false);

    Sync.resetVersion();
    drawPreview();
    setState('IDLE');
  }

  /**
   * È¶ñÊ¨°ÈÄ£Á∑öÂø´ÁÖßÊÅ¢Âæ©ÔºàLate-Join RecoveryÔºâ
   * Ê†πÊìöÂø´ÁÖßÈáçÂª∫ÁõÆÂâçÁãÄÊÖã
   */
  function handleFirstSync(snapshot) {
    if (!snapshot) return;

    const snapshotState = snapshot.state;

    // IDLE ÁãÄÊÖã‰∏çÈúÄË¶ÅÂÅö‰ªÄÈ∫º
    if (snapshotState === 'IDLE') {
      setState('IDLE');
      return;
    }

    // ÈúÄË¶ÅÂª∫Á´ãÁêÉÈ´îÁöÑÁãÄÊÖã
    const needsBalls = ['LOADING', 'READY', 'SPINNING', 'DRAWING', 'COMPLETE'];
    if (needsBalls.includes(snapshotState)) {
      const s = snapshot.settings || {};
      applySettings(s);
      applyUserSettings();

      // ÈÅéÊøæÊéâÂ∑≤‰∏≠ÁçéËÄÖÔºàÂè™Âª∫Á´ãÂâ©È§òÁêÉÈ´îÔºâ
      const allNames = snapshot.names || [];
      const wonNames = snapshot.winners || [];
      const remainingNames = allNames.filter(n => !wonNames.includes(n));

      // Âª∫Á´ãÂÖ®ÂêçÂñÆÈ°ØÁ§∫
      allNamesWithStatus = allNames.map(n => ({
        name: n,
        won: wonNames.includes(n)
      }));
      populateNamesList();

      // È°ØÁ§∫Â∑≤‰∏≠ÁçéËÄÖ
      wonNames.forEach(name => {
        winnerList.appendChild(createWinnerLi(name));
      });
      winners = wonNames.slice();

      if (snapshotState === 'COMPLETE' || remainingNames.length === 0) {
        // ÂÖ®ÈÉ®ÊäΩÂÆå
        setState('COMPLETE');
        drawPreview();
        return;
      }

      // Âª∫Á´ãÂâ©È§òÁêÉÈ´î
      names = remainingNames;
      const { width, height } = Renderer.getSize();
      Physics.layout(width, height);
      startLoop();

      Physics.createBalls(remainingNames, ballRadius, () => {
        Physics.sealContainer();
        Renderer.setLidSealed(true);

        if (snapshot.turbulenceActive) {
          Physics.startTurbulence();
          setState(snapshotState === 'DRAWING' ? 'DRAWING' : 'SPINNING');
        } else {
          setState(snapshotState);
        }
      });
    }
  }

  // ===== Firebase ÈÅôÊéßÂô®Áõ£ËÅΩÔºàMaster Â∞àÁî®Ôºâ =====

  function startFirebaseCommandListener() {
    if (typeof FirebaseDB === 'undefined') return;

    FirebaseDB.commandRef.on('value', snapshot => {
      const cmd = snapshot.val();
      if (!cmd || !cmd.action || !cmd.timestamp) return;

      // ÊØîÂ∞ç timestamp ÈÅøÂÖçÈáçË§áÂü∑Ë°å
      if (cmd.timestamp <= lastFirebaseTimestamp) return;
      lastFirebaseTimestamp = cmd.timestamp;

      switch (cmd.action) {
        case 'LOAD':
          handleLoad();
          break;
        case 'SPIN':
          handleSpin();
          break;
        case 'DRAW':
          handleDraw();
          break;
        case 'RESET':
          handleReset();
          break;
      }
    });
  }

  // ===== ‰∫ã‰ª∂Á∂ÅÂÆö =====

  function bindEvents() {
    if (IS_MASTER) {
      btnLoad.addEventListener('click', () => handleLoad());
      btnSpin.addEventListener('click', () => handleSpin());
      btnDraw.addEventListener('click', () => handleDraw());
      btnReset.addEventListener('click', () => handleReset());
      inputSwirl.addEventListener('input', handleSwirlChange);
      inputFontSize.addEventListener('input', handleFontSizeChange);
      document.querySelectorAll('.preset-btn[data-ball]').forEach(btn => {
        btn.addEventListener('click', () => {
          inputBallSize.value = btn.dataset.ball;
        });
      });
    }
    window.addEventListener('resize', handleResize);
  }

  // ===== ÂïüÂãï =====

  async function start() {
    // Viewer Ê®°ÂºèÂä†‰∏ä CSS class
    if (IS_VIEWER) {
      document.body.classList.add('viewer-mode');
    }

    try {
      await loadSheetNames();
      await loadNamesFromSheets();
      await loadSettings();
    } catch (e) {
      console.error('ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', e);
    }

    refreshNameDisplay();
    bindEvents();

    // ÂàáÊèõÂ∑•‰ΩúË°®ÊôÇÈáçÊñ∞ËºâÂÖ•ÂêçÂñÆ
    if (IS_MASTER) {
      selectSheet.addEventListener('change', async () => {
        if (state !== 'IDLE') return;
        try {
          await loadNamesFromSheets();
        } catch (e) {
          console.error('ÂàáÊèõÂ∑•‰ΩúË°®Â§±Êïó:', e);
        }
        refreshNameDisplay();
      });
    }

    updateUI();
    drawPreview();

    if (IS_MASTER) {
      // Master ÂïüÂãï Firebase ÈÅôÊéßÂô®Áõ£ËÅΩ + ÂØ´ÂÖ•ÂàùÂßã status
      startFirebaseCommandListener();
      writeFirebaseStatus();
    }

    if (IS_VIEWER) {
      // Viewer ÂïüÂãï polling
      Sync.startPolling(
        handleSyncCommands,
        handleFirstSync,
        (errMsg) => {
          if (viewerStatus) viewerStatus.classList.add('disconnected');
          if (viewerStatusText) viewerStatusText.textContent = errMsg;
        }
      );
    }
  }

  start();
})();
</script>
